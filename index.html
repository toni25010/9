<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Si-3.26 | –ü–ª–∞—Ç–Ω—ã–π MOEX API + DeepSeek</title>
    <style>
        /* –°—Ç–∏–ª–∏ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π (–º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –∫–∞–∫ –≤ –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏) */
    </style>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <div class="container">
        <h1>üìà –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Si-3.26 (MOEX, –ø–ª–∞—Ç–Ω—ã–π –¥–æ—Å—Ç—É–ø) + DeepSeek AI</h1>

        <div class="api-section" style="flex-direction: column; align-items: stretch;">
            <h3>–î–∞–Ω–Ω—ã–µ –¥–ª—è –≤—Ö–æ–¥–∞ –≤ –õ–ö–£ –ú–æ—Å–∫–æ–≤—Å–∫–æ–π –±–∏—Ä–∂–∏</h3>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <input type="text" id="moexUsername" class="api-input" placeholder="–õ–æ–≥–∏–Ω –õ–ö–£ MOEX" value="">
                <input type="password" id="moexPassword" class="api-input" placeholder="–ü–∞—Ä–æ–ª—å –õ–ö–£ MOEX" value="">
            </div>
            <h3 style="margin-top: 15px;">DeepSeek API –∫–ª—é—á</h3>
            <div style="display: flex; gap: 15px; flex-wrap: wrap;">
                <input type="password" id="deepseekApiKey" class="api-input" placeholder="DeepSeek API –∫–ª—é—á" value="">
            </div>
            <div style="display: flex; gap: 15px; margin-top: 15px;">
                <button id="authBtn">üîë –ê–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –∏ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ</button>
                <button id="analyzeBtn" disabled>üîç –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å</button>
            </div>
        </div>

        <div class="chart-container">
            <div class="watermark">Si-3.26 (MOEX REAL-TIME)</div>
            <div id="chart"></div>
            <div id="dataStatus" class="error-message" style="display: none;"></div>
        </div>

        <div class="indicators-panel" id="indicatorsPanel">
            <div class="indicator-card"><h3>–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è...</h3><div class="value">--</div></div>
        </div>

        <div class="analysis-result">
            <div class="result-header">
                <h2>üß† –ê–Ω–∞–ª–∏–∑ DeepSeek</h2>
                <div id="loader" class="loader" style="display: none;"></div>
            </div>
            <pre id="analysisText">–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –Ω–∞ MOEX</pre>
        </div>
        <footer>
            –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–ª–∞—Ç–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ –Ω–∞ –¥–∞–Ω–Ω—ã–µ MOEX (Futures & Options) [citation:6][citation:9]
        </footer>
    </div>

    <script>
        (function() {
            // –°–æ—Å—Ç–æ—è–Ω–∏–µ
            let moexToken = null;
            let rawData = [];
            let sma20 = [], sma50 = [], rsi = [], macd = {};

            // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
            const usernameInput = document.getElementById('moexUsername');
            const passwordInput = document.getElementById('moexPassword');
            const deepseekInput = document.getElementById('deepseekApiKey');
            const authBtn = document.getElementById('authBtn');
            const analyzeBtn = document.getElementById('analyzeBtn');
            const statusDiv = document.getElementById('dataStatus');
            const panel = document.getElementById('indicatorsPanel');
            const chartDiv = document.getElementById('chart');
            const analysisDiv = document.getElementById('analysisText');
            const loader = document.getElementById('loader');

            // ---------- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (—Ç–µ –∂–µ —Ñ—É–Ω–∫—Ü–∏–∏) ----------
            function calculateSMA(data, period) {
                let sma = [];
                for (let i = 0; i < data.length; i++) {
                    if (i < period - 1) { sma.push(null); continue; }
                    let sum = 0;
                    for (let j = i - period + 1; j <= i; j++) sum += data[j].close;
                    sma.push(sum / period);
                }
                return sma;
            }

            function calculateRSI(data, period = 14) {
                let rsi = [];
                let gains = [], losses = [];
                for (let i = 1; i < data.length; i++) {
                    let change = data[i].close - data[i-1].close;
                    gains.push(change > 0 ? change : 0);
                    losses.push(change < 0 ? -change : 0);
                }
                for (let i = 0; i < data.length; i++) {
                    if (i < period) { rsi.push(null); continue; }
                    let avgGain = 0, avgLoss = 0;
                    for (let j = i - period; j < i; j++) {
                        avgGain += gains[j];
                        avgLoss += losses[j];
                    }
                    avgGain /= period; avgLoss /= period;
                    if (avgLoss === 0) rsi.push(100);
                    else rsi.push(100 - (100 / (1 + avgGain / avgLoss)));
                }
                return rsi;
            }

            function calculateMACD(data, fast = 12, slow = 26, signal = 9) {
                let emaFast = [], emaSlow = [], macdLine = [], signalLine = [], histogram = [];
                let sumFast = 0, sumSlow = 0;
                for (let i = 0; i < slow; i++) {
                    if (i < fast) sumFast += data[i].close;
                    sumSlow += data[i].close;
                }
                emaFast[fast-1] = sumFast / fast;
                emaSlow[slow-1] = sumSlow / slow;
                const kFast = 2 / (fast + 1), kSlow = 2 / (slow + 1);
                for (let i = fast; i < data.length; i++) emaFast[i] = data[i].close * kFast + emaFast[i-1] * (1 - kFast);
                for (let i = slow; i < data.length; i++) emaSlow[i] = data[i].close * kSlow + emaSlow[i-1] * (1 - kSlow);
                for (let i = 0; i < data.length; i++) {
                    if (i < slow) macdLine.push(null);
                    else macdLine.push(emaFast[i] - emaSlow[i]);
                }
                for (let i = 0; i < data.length; i++) {
                    if (i < slow + signal - 1) { signalLine.push(null); continue; }
                    if (i === slow + signal - 1) {
                        let sum = 0;
                        for (let j = i - signal + 1; j <= i; j++) sum += macdLine[j];
                        signalLine.push(sum / signal);
                    } else {
                        let prevSignal = signalLine[i-1];
                        signalLine.push(macdLine[i] * (2/(signal+1)) + prevSignal * (1 - 2/(signal+1)));
                    }
                }
                for (let i = 0; i < data.length; i++) {
                    if (signalLine[i] === null) histogram.push(null);
                    else histogram.push(macdLine[i] - signalLine[i]);
                }
                return { macdLine, signalLine, histogram };
            }

            // ---------- –ü–æ–ª—É—á–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞ MOEX ----------
            async function getMoexToken(username, password) {
                const response = await fetch('/api/moex-token', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Auth failed');
                }

                return await response.json();
            }

            // ---------- –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö Si-3.26 —Å MOEX ----------
            async function fetchSiData(token) {
                // –î–∞—Ç–∞: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π
                const endDate = new Date();
                const startDate = new Date();
                startDate.setDate(startDate.getDate() - 7);

                const formatDate = (d) => d.toISOString().split('T')[0];
                
                // URL –¥–ª—è —á–∞—Å–æ–≤—ã—Ö —Å–≤–µ—á–µ–π Si-3.26 (—Å—Ä–æ—á–Ω—ã–π —Ä—ã–Ω–æ–∫) [citation:8]
                const moexUrl = `https://iss.moex.com/iss/engines/futures/markets/forts/boards/forts/securities/Si-3.26/candles.json?from=${formatDate(startDate)}&till=${formatDate(endDate)}&interval=60&iss.only=candles`;

                const response = await fetch(`/api/proxy?url=${encodeURIComponent(moexUrl)}`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }

                const data = await response.json();

                if (!data.candles || !data.candles.data) {
                    throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–ø–∏—Å–∫—É –Ω–∞ Futures & Options [citation:6]');
                }

                // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö MOEX [open, close, high, low, ..., begin]
                return data.candles.data.map(candle => ({
                    time: Math.floor(new Date(candle[6]).getTime() / 1000),
                    open: candle[0],
                    high: candle[2],
                    low: candle[3],
                    close: candle[1]
                })).sort((a, b) => a.time - b.time);
            }

            // ---------- –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≥—Ä–∞—Ñ–∏–∫–∞ ----------
            function drawChart() {
                chartDiv.innerHTML = '';
                const chart = LightweightCharts.createChart(chartDiv, {
                    width: chartDiv.clientWidth,
                    height: 500,
                    layout: { backgroundColor: '#2a2c39', textColor: '#d1d4dc' },
                    grid: { vertLines: { color: '#404254' }, horzLines: { color: '#404254' } },
                    timeScale: { timeVisible: true }
                });

                const candlestickSeries = chart.addCandlestickSeries({
                    upColor: '#4caf50', downColor: '#f44336',
                    title: 'Si-3.26 (—Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)'
                });
                candlestickSeries.setData(rawData);

                if (sma20.length) {
                    const sma20Line = chart.addLineSeries({ color: '#FFD700', lineWidth: 2 });
                    sma20Line.setData(rawData.map((d, i) => sma20[i] ? { time: d.time, value: sma20[i] } : null).filter(Boolean));
                }

                chart.timeScale().fitContent();
            }

            // ---------- –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ ----------
            function updateIndicators() {
                if (!rawData.length) return;
                const last = rawData[rawData.length - 1];
                const prev = rawData[rawData.length - 2] || last;
                panel.innerHTML = `
                    <div class="indicator-card"><h3>Si-3.26</h3><div class="value">${last.close.toFixed(2)}</div></div>
                    <div class="indicator-card"><h3>SMA20</h3><div class="value">${sma20[sma20.length-1]?.toFixed(2) || 'N/A'}</div></div>
                    <div class="indicator-card"><h3>SMA50</h3><div class="value">${sma50[sma50.length-1]?.toFixed(2) || 'N/A'}</div></div>
                    <div class="indicator-card"><h3>RSI(14)</h3><div class="value">${rsi[rsi.length-1]?.toFixed(2) || 'N/A'}</div></div>
                `;
            }

            // ---------- –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –∏ –∑–∞–≥—Ä—É–∑–∫–∏ ----------
            authBtn.addEventListener('click', async () => {
                const username = usernameInput.value.trim();
                const password = passwordInput.value.trim();

                if (!username || !password) {
                    statusDiv.style.display = 'block';
                    statusDiv.textContent = '‚ùå –í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –∏ –ø–∞—Ä–æ–ª—å –õ–ö–£ MOEX';
                    return;
                }

                loader.style.display = 'inline-block';
                authBtn.disabled = true;
                statusDiv.style.display = 'none';

                try {
                    // 1. –ü–æ–ª—É—á–∞–µ–º —Ç–æ–∫–µ–Ω
                    const tokenData = await getMoexToken(username, password);
                    moexToken = tokenData.access_token;

                    // 2. –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ Si-3.26
                    rawData = await fetchSiData(moexToken);

                    // 3. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
                    sma20 = calculateSMA(rawData, 20);
                    sma50 = calculateSMA(rawData, 50);
                    rsi = calculateRSI(rawData, 14);
                    macd = calculateMACD(rawData, 12, 26, 9);

                    // 4. –û—Ç—Ä–∏—Å–æ–≤—ã–≤–∞–µ–º
                    drawChart();
                    updateIndicators();

                    // 5. –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∞–Ω–∞–ª–∏–∑
                    analyzeBtn.disabled = false;
                    analysisDiv.innerText = '–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ù–∞–∂–º–∏—Ç–µ "–ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å"';

                } catch (error) {
                    console.error(error);
                    statusDiv.style.display = 'block';
                    statusDiv.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                } finally {
                    loader.style.display = 'none';
                    authBtn.disabled = false;
                }
            });

            // ---------- –ê–Ω–∞–ª–∏–∑ —á–µ—Ä–µ–∑ DeepSeek ----------
            analyzeBtn.addEventListener('click', async () => {
                const deepseekKey = deepseekInput.value.trim();
                if (!deepseekKey) {
                    analysisDiv.innerText = '‚ùå –í–≤–µ–¥–∏—Ç–µ DeepSeek API –∫–ª—é—á';
                    return;
                }

                loader.style.display = 'inline-block';
                analyzeBtn.disabled = true;

                try {
                    // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–æ–º–ø—Ç —Å –ø–æ—Å–ª–µ–¥–Ω–∏–º–∏ 60 —Å–≤–µ—á–∞–º–∏
                    const recent = rawData.slice(-60);
                    const csv = ['Time,Open,High,Low,Close,SMA20,SMA50,RSI']
                        .concat(recent.map((d, i) => {
                            const idx = rawData.length - 60 + i;
                            return `${new Date(d.time*1000).toISOString()},${d.open},${d.high},${d.low},${d.close},${sma20[idx]?.toFixed(2)||''},${sma50[idx]?.toFixed(2)||''},${rsi[idx]?.toFixed(2)||''}`;
                        })).join('\n');

                    const response = await fetch('/api/proxy', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${deepseekKey}`
                        },
                        body: JSON.stringify({
                            model: 'deepseek-chat',
                            messages: [
                                { role: 'system', content: '–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç—Ä–µ–π–¥–µ—Ä. –ê–Ω–∞–ª–∏–∑–∏—Ä—É–π –¥–∞–Ω–Ω—ã–µ Si-3.26.' },
                                { role: 'user', content: `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —á–∞—Å–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ Si-3.26 (—Ñ—å—é—á–µ—Ä—Å –Ω–∞ –¥–æ–ª–ª–∞—Ä/—Ä—É–±–ª—å):\n\`\`\`csv\n${csv}\n\`\`\`` }
                            ]
                        })
                    });

                    const data = await response.json();
                    analysisDiv.innerText = data.choices[0].message.content;
                } catch (error) {
                    analysisDiv.innerText = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                } finally {
                    loader.style.display = 'none';
                    analyzeBtn.disabled = false;
                }
            });
        })();
    </script>
</body>
</html>
