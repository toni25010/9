<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ê–Ω–∞–ª–∏–∑ Si-3.26 —Å DeepSeek API (—á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ Vercel)</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #1e1f2b; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #b0b7ca; font-weight: 400; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .api-section { background: #2a2c39; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; flex-wrap: wrap; align-items: center; gap: 15px; }
        .api-input { flex: 1; min-width: 300px; background: #1e1f2b; border: 1px solid #444; color: white; padding: 12px 15px; border-radius: 6px; font-size: 14px; }
        .api-input:focus { outline: none; border-color: #5f9ea0; }
        button { background: #3a6ea5; border: none; color: white; padding: 12px 30px; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        button:hover { background: #4d7db8; }
        button:disabled { background: #555; cursor: not-allowed; }
        .chart-container { background: #2a2c39; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        #chart { width: 100%; height: 500px; }
        .indicators-panel { background: #2a2c39; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 14px; }
        .indicator-card { background: #1e1f2b; padding: 15px; border-radius: 6px; border-left: 4px solid #5f9ea0; }
        .indicator-card h3 { margin: 0 0 10px 0; color: #b0b7ca; font-size: 16px; font-weight: 400; }
        .indicator-card .value { font-size: 22px; font-weight: 600; color: #d4d7e3; }
        .indicator-card .detail { color: #888c9e; margin-top: 5px; }
        .analysis-result { background: #2a2c39; padding: 20px; border-radius: 8px; }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .result-header h2 { margin: 0; color: #b0b7ca; font-weight: 400; }
        .loader { border: 3px solid #444; border-top: 3px solid #5f9ea0; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        pre { background: #1e1f2b; padding: 20px; border-radius: 6px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; color: #c9d1d9; font-family: 'Consolas', monospace; font-size: 14px; line-height: 1.6; margin: 0; }
        .error-message { color: #f28b82; padding: 10px; background: #442326; border-radius: 4px; }
        footer { margin-top: 20px; text-align: center; color: #555a6b; font-size: 13px; }
    </style>
    <!-- –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º unpkg —Å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –≤–µ—Ä—Å–∏–µ–π 4.1.0 -->
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <div class="container">
        <h1>üìà –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑ Si-3.26 (—á–∞—Å–æ–≤–æ–π –≥—Ä–∞—Ñ–∏–∫) —Å DeepSeek AI</h1>

        <div class="api-section">
            <input type="password" id="apiKey" class="api-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à DeepSeek API –∫–ª—é—á" value="">
            <button id="analyzeBtn">üîç –í—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑</button>
        </div>

        <div class="chart-container">
            <div id="chart"></div>
        </div>

        <div class="indicators-panel" id="indicatorsPanel">
            <!-- –ó–∞–ø–æ–ª–Ω—è–µ—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
        </div>

        <div class="analysis-result">
            <div class="result-header">
                <h2>üß† –ê–Ω–∞–ª–∏–∑ DeepSeek</h2>
                <div id="loader" class="loader" style="display: none;"></div>
            </div>
            <pre id="analysisText">–ù–∞–∂–º–∏—Ç–µ "–í—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑" –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ API –∫–ª—é—á–∞.</pre>
        </div>
        <footer>
            –î–∞–Ω–Ω—ã–µ —Å–∏–º—É–ª–∏—Ä–æ–≤–∞–Ω—ã –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞. –†–µ–∞–ª—å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —Ç—Ä–µ–±—É–µ—Ç API –∫–ª—é—á DeepSeek.
        </footer>
    </div>

    <script>
        (function() {
            // ---------- –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö ----------
            function generateSampleData() {
                const data = [];
                const startTime = Math.floor(Date.now() / 1000) - 200 * 3600;
                let close = 92_500;
                for (let i = 0; i < 200; i++) {
                    const time = startTime + i * 3600;
                    const volatility = 300 + Math.random() * 400;
                    const open = close;
                    const change = (Math.random() - 0.5) * volatility;
                    close = open + change;
                    if (i > 80 && i < 120) close += 20;
                    if (i > 130 && i < 160) close -= 25;
                    const high = Math.max(open, close) + Math.random() * volatility * 0.7;
                    const low = Math.min(open, close) - Math.random() * volatility * 0.7;
                    const volume = Math.floor(5000 + Math.random() * 20000);
                    data.push({
                        time: time,
                        open: Math.round(open * 100) / 100,
                        high: Math.round(high * 100) / 100,
                        low: Math.round(low * 100) / 100,
                        close: Math.round(close * 100) / 100,
                        volume: volume
                    });
                }
                return data;
            }

            // ---------- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã ----------
            function calculateSMA(data, period) {
                let sma = [];
                for (let i = 0; i < data.length; i++) {
                    if (i < period - 1) { sma.push(null); continue; }
                    let sum = 0;
                    for (let j = i - period + 1; j <= i; j++) sum += data[j].close;
                    sma.push(sum / period);
                }
                return sma;
            }

            function calculateRSI(data, period = 14) {
                let rsi = [];
                let gains = [], losses = [];
                for (let i = 1; i < data.length; i++) {
                    let change = data[i].close - data[i-1].close;
                    gains.push(change > 0 ? change : 0);
                    losses.push(change < 0 ? -change : 0);
                }
                for (let i = 0; i < data.length; i++) {
                    if (i < period) { rsi.push(null); continue; }
                    let avgGain = 0, avgLoss = 0;
                    for (let j = i - period; j < i; j++) {
                        avgGain += gains[j];
                        avgLoss += losses[j];
                    }
                    avgGain /= period; avgLoss /= period;
                    if (avgLoss === 0) rsi.push(100);
                    else rsi.push(100 - (100 / (1 + avgGain / avgLoss)));
                }
                return rsi;
            }

            function calculateMACD(data, fast = 12, slow = 26, signal = 9) {
                let emaFast = [], emaSlow = [], macdLine = [], signalLine = [], histogram = [];
                let sumFast = 0, sumSlow = 0;
                for (let i = 0; i < slow; i++) {
                    if (i < fast) sumFast += data[i].close;
                    sumSlow += data[i].close;
                }
                emaFast[fast-1] = sumFast / fast;
                emaSlow[slow-1] = sumSlow / slow;
                const kFast = 2 / (fast + 1), kSlow = 2 / (slow + 1);
                for (let i = fast; i < data.length; i++) emaFast[i] = data[i].close * kFast + emaFast[i-1] * (1 - kFast);
                for (let i = slow; i < data.length; i++) emaSlow[i] = data[i].close * kSlow + emaSlow[i-1] * (1 - kSlow);
                for (let i = 0; i < data.length; i++) {
                    if (i < slow) macdLine.push(null);
                    else macdLine.push(emaFast[i] - emaSlow[i]);
                }
                for (let i = 0; i < data.length; i++) {
                    if (i < slow + signal - 1) { signalLine.push(null); continue; }
                    if (i === slow + signal - 1) {
                        let sum = 0;
                        for (let j = i - signal + 1; j <= i; j++) sum += macdLine[j];
                        signalLine.push(sum / signal);
                    } else {
                        let prevSignal = signalLine[i-1];
                        signalLine.push(macdLine[i] * (2/(signal+1)) + prevSignal * (1 - 2/(signal+1)));
                    }
                }
                for (let i = 0; i < data.length; i++) {
                    if (signalLine[i] === null) histogram.push(null);
                    else histogram.push(macdLine[i] - signalLine[i]);
                }
                return { macdLine, signalLine, histogram };
            }

            // ---------- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ ----------
            const rawData = generateSampleData();
            const sma20 = calculateSMA(rawData, 20);
            const sma50 = calculateSMA(rawData, 50);
            const rsi = calculateRSI(rawData, 14);
            const macd = calculateMACD(rawData, 12, 26, 9);

            function updateIndicatorsPanel() {
                const last = rawData[rawData.length - 1];
                const prev = rawData[rawData.length - 2];
                const panel = document.getElementById('indicatorsPanel');
                const lastRsi = rsi[rsi.length - 1]?.toFixed(2) || 'N/A';
                const lastMacd = macd.macdLine[macd.macdLine.length - 1]?.toFixed(2) || 'N/A';
                const lastSignal = macd.signalLine[macd.signalLine.length - 1]?.toFixed(2) || 'N/A';
                const lastHist = macd.histogram[macd.histogram.length - 1]?.toFixed(2) || 'N/A';
                const sma20Val = sma20[sma20.length - 1]?.toFixed(2) || 'N/A';
                const sma50Val = sma50[sma50.length - 1]?.toFixed(2) || 'N/A';

                panel.innerHTML = `
                    <div class="indicator-card"><h3>–¶–µ–Ω–∞ –∑–∞–∫—Ä—ã—Ç–∏—è</h3><div class="value">${last.close.toFixed(2)}</div><div class="detail">–ò–∑–º: ${(last.close - prev.close).toFixed(2)}</div></div>
                    <div class="indicator-card"><h3>SMA 20 / 50</h3><div class="value">${sma20Val} / ${sma50Val}</div><div class="detail">${sma20Val > sma50Val ? 'üêÇ –ë—ã—á—å–µ' : 'üêª –ú–µ–¥–≤–µ–∂—å–µ'} –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ</div></div>
                    <div class="indicator-card"><h3>RSI (14)</h3><div class="value">${lastRsi}</div><div class="detail">${lastRsi > 70 ? '–ü–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å' : lastRsi < 30 ? '–ü–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å' : '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ'}</div></div>
                    <div class="indicator-card"><h3>MACD</h3><div class="value">${lastMacd}</div><div class="detail">–°–∏–≥–Ω–∞–ª: ${lastSignal} | –ì–∏—Å—Ç: ${lastHist}</div></div>
                `;
            }

            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
            if (typeof LightweightCharts === 'undefined') {
                document.getElementById('chart').innerHTML = '<div class="error-message">–û—à–∏–±–∫–∞: –Ω–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –±–∏–±–ª–∏–æ—Ç–µ–∫—É –≥—Ä–∞—Ñ–∏–∫–æ–≤. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç.</div>';
            } else {
                try {
                    const chartContainer = document.getElementById('chart');
                    const chart = LightweightCharts.createChart(chartContainer, {
                        width: chartContainer.clientWidth,
                        height: 500,
                        layout: { backgroundColor: '#2a2c39', textColor: '#d1d4dc' },
                        grid: { vertLines: { color: '#404254' }, horzLines: { color: '#404254' } },
                        timeScale: { timeVisible: true, secondsVisible: false },
                    });

                    const candlestickSeries = chart.addCandlestickSeries({
                        upColor: '#4caf50', downColor: '#f44336',
                        borderDownColor: '#f44336', borderUpColor: '#4caf50',
                        wickDownColor: '#f44336', wickUpColor: '#4caf50',
                    });
                    candlestickSeries.setData(rawData);

                    const sma20Line = chart.addLineSeries({ color: '#FFD700', lineWidth: 2, title: 'SMA20' });
                    const sma50Line = chart.addLineSeries({ color: '#00BFFF', lineWidth: 2, title: 'SMA50' });
                    
                    const sma20Data = [], sma50Data = [];
                    rawData.forEach((d, i) => {
                        if (sma20[i] !== null) sma20Data.push({ time: d.time, value: sma20[i] });
                        if (sma50[i] !== null) sma50Data.push({ time: d.time, value: sma50[i] });
                    });
                    sma20Line.setData(sma20Data);
                    sma50Line.setData(sma50Data);

                    chart.timeScale().fitContent();

                    window.addEventListener('resize', () => chart.applyOptions({ width: chartContainer.clientWidth }));
                } catch (e) {
                    console.error(e);
                    document.getElementById('chart').innerHTML = '<div class="error-message">–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–µ –≥—Ä–∞—Ñ–∏–∫–∞: ' + e.message + '</div>';
                }
            }

            updateIndicatorsPanel();

            // ---------- API –ó–∞–ø—Ä–æ—Å ----------
            function buildAnalysisPrompt() {
                const recent = rawData.slice(-60);
                const headers = ['Time', 'Open', 'High', 'Low', 'Close', 'SMA20', 'SMA50', 'RSI', 'MACD', 'Signal', 'Histogram'];
                let csvRows = [headers.join(',')];

                recent.forEach((d, idx) => {
                    const globalIdx = rawData.length - 60 + idx;
                    const row = [
                        new Date(d.time * 1000).toISOString().replace('T', ' ').substring(0, 19),
                        d.open.toFixed(2), d.high.toFixed(2), d.low.toFixed(2), d.close.toFixed(2),
                        sma20[globalIdx]?.toFixed(2) || '', sma50[globalIdx]?.toFixed(2) || '',
                        rsi[globalIdx]?.toFixed(2) || '', macd.macdLine[globalIdx]?.toFixed(2) || '',
                        macd.signalLine[globalIdx]?.toFixed(2) || '', macd.histogram[globalIdx]?.toFixed(2) || ''
                    ];
                    csvRows.push(row.join(','));
                });

                return `–¢—ã –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑–µ—Ä... (–æ—Å—Ç–∞–ª—å–Ω–æ–π —Ç–µ–∫—Å—Ç –ø—Ä–æ–º–ø—Ç–∞ –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π –¥–ª—è –∫—Ä–∞—Ç–∫–æ—Å—Ç–∏) ...\n\`\`\`csv\n${csvRows.join('\n')}\n\`\`\``;
            }

            document.getElementById('analyzeBtn').addEventListener('click', async function() {
                const apiKey = document.getElementById('apiKey').value.trim();
                if (!apiKey) {
                    document.getElementById('analysisText').innerText = '‚ùå –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á.';
                    return;
                }

                const loader = document.getElementById('loader');
                const analysisDiv = document.getElementById('analysisText');
                loader.style.display = 'inline-block';
                analysisDiv.innerText = '‚è≥ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –∫ DeepSeek API —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏...';

                try {
                    const response = await fetch('/api/proxy', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'deepseek-chat',
                            messages: [
                                { role: 'system', content: '–¢—ã –æ–ø—ã—Ç–Ω—ã–π —Ç—Ä–µ–π–¥–µ—Ä.' },
                                { role: 'user', content: buildAnalysisPrompt() }
                            ],
                            temperature: 0.3
                        })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error?.message || JSON.stringify(data));
                    
                    analysisDiv.innerText = data.choices[0].message.content;
                } catch (error) {
                    console.error(error);
                    analysisDiv.innerText = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                } finally {
                    loader.style.display = 'none';
                }
            });
        })();
    </script>
</body>
</html>
