<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–†–µ–∞–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ Si-3.26 (MOEX) + DeepSeek AI</title>
    <style>
        /* –°—Ç–∏–ª–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–¥–µ–Ω—Ç–∏—á–Ω—ã –ø—Ä–µ–¥—ã–¥—É—â–µ–π –≤–µ—Ä—Å–∏–∏ */
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #1e1f2b; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #b0b7ca; font-weight: 400; border-bottom: 1px solid #333; padding-bottom: 10px; }
        .api-section { background: #2a2c39; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; flex-wrap: wrap; align-items: center; gap: 15px; }
        .api-input { flex: 1; min-width: 300px; background: #1e1f2b; border: 1px solid #444; color: white; padding: 12px 15px; border-radius: 6px; font-size: 14px; }
        .api-input:focus { outline: none; border-color: #5f9ea0; }
        button { background: #3a6ea5; border: none; color: white; padding: 12px 30px; border-radius: 6px; font-size: 16px; font-weight: 600; cursor: pointer; transition: background 0.2s; }
        button:hover { background: #4d7db8; }
        button:disabled { background: #555; cursor: not-allowed; }
        .chart-container { background: #2a2c39; padding: 20px; border-radius: 8px; margin-bottom: 20px; position: relative; }
        #chart { width: 100%; height: 500px; }
        .indicators-panel { background: #2a2c39; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; font-size: 14px; }
        .indicator-card { background: #1e1f2b; padding: 15px; border-radius: 6px; border-left: 4px solid #5f9ea0; }
        .indicator-card h3 { margin: 0 0 10px 0; color: #b0b7ca; font-size: 16px; font-weight: 400; }
        .indicator-card .value { font-size: 22px; font-weight: 600; color: #d4d7e3; }
        .indicator-card .detail { color: #888c9e; margin-top: 5px; }
        .analysis-result { background: #2a2c39; padding: 20px; border-radius: 8px; }
        .result-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .result-header h2 { margin: 0; color: #b0b7ca; font-weight: 400; }
        .loader { border: 3px solid #444; border-top: 3px solid #5f9ea0; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        pre { background: #1e1f2b; padding: 20px; border-radius: 6px; overflow-x: auto; white-space: pre-wrap; word-wrap: break-word; color: #c9d1d9; font-family: 'Consolas', monospace; font-size: 14px; line-height: 1.6; margin: 0; }
        .error-message { color: #f28b82; padding: 10px; background: #442326; border-radius: 4px; margin-bottom: 10px; }
        .watermark { position: absolute; top: 70px; left: 80px; font-size: 24px; color: rgba(255,255,255,0.1); pointer-events: none; font-weight: bold; z-index: 1; }
        footer { margin-top: 20px; text-align: center; color: #555a6b; font-size: 13px; }
    </style>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º –±–∏–±–ª–∏–æ—Ç–µ–∫—É –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <div class="container">
        <h1>üìà –†–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Si-3.26 (MOEX) + –∞–Ω–∞–ª–∏–∑ DeepSeek</h1>

        <div class="api-section">
            <input type="password" id="apiKey" class="api-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à DeepSeek API –∫–ª—é—á" value="">
            <button id="analyzeBtn">üîç –í—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑</button>
        </div>

        <div class="chart-container">
            <div class="watermark">Si-3.26 (MOEX ISS)</div>
            <div id="chart"></div>
            <div id="dataStatus" class="error-message" style="display: none;"></div>
        </div>

        <div class="indicators-panel" id="indicatorsPanel">
            <div class="indicator-card"><h3>–ó–∞–≥—Ä—É–∑–∫–∞...</h3><div class="value">--</div></div>
        </div>

        <div class="analysis-result">
            <div class="result-header">
                <h2>üß† –ê–Ω–∞–ª–∏–∑ DeepSeek</h2>
                <div id="loader" class="loader" style="display: none;"></div>
            </div>
            <pre id="analysisText">–ù–∞–∂–º–∏—Ç–µ "–í—ã–ø–æ–ª–Ω–∏—Ç—å –∞–Ω–∞–ª–∏–∑" –ø–æ—Å–ª–µ –≤–≤–æ–¥–∞ API –∫–ª—é—á–∞.</pre>
        </div>
        <footer>
            –ò—Å—Ç–æ—á–Ω–∏–∫ –¥–∞–Ω–Ω—ã—Ö: MOEX ISS (–∑–∞–¥–µ—Ä–∂–∫–∞ 15 –º–∏–Ω—É—Ç –¥–ª—è –Ω–µ–∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π).
        </footer>
    </div>

    <script>
        (function() {
            // --- –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
            const SECURITY_ID = 'Si-3.26';
            
            // ---------- –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å MOEX —á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏ ----------
            async function fetchRealMoexData() {
                const statusDiv = document.getElementById('dataStatus');
                
                try {
                    // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –¥–∞—Ç—ã: –ø–æ—Å–ª–µ–¥–Ω–∏–µ 7 –¥–Ω–µ–π (—á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å ~200 —á–∞—Å–æ–≤—ã—Ö —Å–≤–µ—á–µ–π)
                    const endDate = new Date();
                    const startDate = new Date();
                    startDate.setDate(startDate.getDate() - 7);
                    
                    // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º –¥–∞—Ç—ã –≤ —Ñ–æ—Ä–º–∞—Ç YYYY-MM-DD
                    const formatDate = (date) => {
                        return date.toISOString().split('T')[0];
                    };
                    
                    const from = formatDate(startDate);
                    const till = formatDate(endDate);
                    
                    // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ –∫ MOEX ISS API
                    // –≠–Ω–¥–ø–æ–∏–Ω—Ç –¥–ª—è —Å–≤–µ—á–µ–π —Ñ—å—é—á–µ—Ä—Å–æ–≤:
                    // /engines/futures/markets/forts/boards/forts/securities/{secid}/candles
                    // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: from, till, interval=60 (—á–∞—Å–æ–≤—ã–µ —Å–≤–µ—á–∏)
                    const moexUrl = `https://iss.moex.com/iss/engines/futures/markets/forts/boards/forts/securities/${SECURITY_ID}/candles.json?from=${from}&till=${till}&interval=60&iss.only=candles`;
                    
                    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à –ø—Ä–æ–∫—Å–∏ –¥–ª—è –æ–±—Ö–æ–¥–∞ CORS
                    const response = await fetch(`/api/proxy?url=${encodeURIComponent(moexUrl)}`);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }
                    
                    const data = await response.json();
                    
                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö
                    if (!data.candles || !data.candles.data || data.candles.data.length === 0) {
                        throw new Error('–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –∑–∞ —É–∫–∞–∑–∞–Ω–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (–≤–æ–∑–º–æ–∂–Ω–æ, –Ω–µ—Ç —Ç–æ—Ä–≥–æ–≤)');
                    }
                    
                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ MOEX –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è Lightweight Charts
                    // –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö MOEX: [open, close, high, low, value, volume, begin]
                    const candles = data.candles.data.map(candle => ({
                        time: Math.floor(new Date(candle[6]).getTime() / 1000), // begin -> timestamp
                        open: candle[0],
                        high: candle[2],
                        low: candle[3],
                        close: candle[1],
                        volume: candle[5]
                    }));
                    
                    // –°–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ –≤—Ä–µ–º–µ–Ω–∏ (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ API –≤–µ—Ä–Ω—ë—Ç –Ω–µ –ø–æ –ø–æ—Ä—è–¥–∫—É)
                    candles.sort((a, b) => a.time - b.time);
                    
                    statusDiv.style.display = 'none';
                    return candles;
                    
                } catch (error) {
                    console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö MOEX:', error);
                    statusDiv.style.display = 'block';
                    statusDiv.textContent = `‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}. –ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ.`;
                    
                    // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∫–∞–∫ –∑–∞–ø–∞—Å–Ω–æ–π –≤–∞—Ä–∏–∞–Ω—Ç
                    return generateFallbackData();
                }
            }

            // ---------- –ó–∞–ø–∞—Å–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä –Ω–∞ —Å–ª—É—á–∞–π –æ—à–∏–±–∫–∏ ----------
            function generateFallbackData() {
                const data = [];
                const now = new Date();
                const nowHourStart = new Date(now);
                nowHourStart.setMinutes(0, 0, 0);
                
                let currentPrice = 92500;
                
                for (let i = 0; i < 100; i++) {
                    const timeOffset = (99 - i) * 3600 * 1000;
                    const candleDate = new Date(nowHourStart.getTime() - timeOffset);
                    const timestamp = Math.floor(candleDate.getTime() / 1000);
                    
                    const change = (Math.random() - 0.48) * 200;
                    const close = currentPrice + change;
                    const high = Math.max(currentPrice, close) + Math.random() * 100;
                    const low = Math.min(currentPrice, close) - Math.random() * 100;
                    
                    data.push({
                        time: timestamp,
                        open: currentPrice,
                        high: high,
                        low: low,
                        close: close,
                    });
                    
                    currentPrice = close;
                }
                return data;
            }

            // ---------- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã (–±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π) ----------
            function calculateSMA(data, period) {
                let sma = [];
                for (let i = 0; i < data.length; i++) {
                    if (i < period - 1) { sma.push(null); continue; }
                    let sum = 0;
                    for (let j = i - period + 1; j <= i; j++) sum += data[j].close;
                    sma.push(sum / period);
                }
                return sma;
            }

            function calculateRSI(data, period = 14) {
                let rsi = [];
                let gains = [], losses = [];
                for (let i = 1; i < data.length; i++) {
                    let change = data[i].close - data[i-1].close;
                    gains.push(change > 0 ? change : 0);
                    losses.push(change < 0 ? -change : 0);
                }
                for (let i = 0; i < data.length; i++) {
                    if (i < period) { rsi.push(null); continue; }
                    let avgGain = 0, avgLoss = 0;
                    for (let j = i - period; j < i; j++) {
                        avgGain += gains[j];
                        avgLoss += losses[j];
                    }
                    avgGain /= period; avgLoss /= period;
                    if (avgLoss === 0) rsi.push(100);
                    else rsi.push(100 - (100 / (1 + avgGain / avgLoss)));
                }
                return rsi;
            }

            function calculateMACD(data, fast = 12, slow = 26, signal = 9) {
                let emaFast = [], emaSlow = [], macdLine = [], signalLine = [], histogram = [];
                let sumFast = 0, sumSlow = 0;
                for (let i = 0; i < slow; i++) {
                    if (i < fast) sumFast += data[i].close;
                    sumSlow += data[i].close;
                }
                emaFast[fast-1] = sumFast / fast;
                emaSlow[slow-1] = sumSlow / slow;
                const kFast = 2 / (fast + 1), kSlow = 2 / (slow + 1);
                for (let i = fast; i < data.length; i++) emaFast[i] = data[i].close * kFast + emaFast[i-1] * (1 - kFast);
                for (let i = slow; i < data.length; i++) emaSlow[i] = data[i].close * kSlow + emaSlow[i-1] * (1 - kSlow);
                for (let i = 0; i < data.length; i++) {
                    if (i < slow) macdLine.push(null);
                    else macdLine.push(emaFast[i] - emaSlow[i]);
                }
                for (let i = 0; i < data.length; i++) {
                    if (i < slow + signal - 1) { signalLine.push(null); continue; }
                    if (i === slow + signal - 1) {
                        let sum = 0;
                        for (let j = i - signal + 1; j <= i; j++) sum += macdLine[j];
                        signalLine.push(sum / signal);
                    } else {
                        let prevSignal = signalLine[i-1];
                        signalLine.push(macdLine[i] * (2/(signal+1)) + prevSignal * (1 - 2/(signal+1)));
                    }
                }
                for (let i = 0; i < data.length; i++) {
                    if (signalLine[i] === null) histogram.push(null);
                    else histogram.push(macdLine[i] - signalLine[i]);
                }
                return { macdLine, signalLine, histogram };
            }

            // ---------- –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ ----------
            let rawData = [];
            let sma20 = [], sma50 = [], rsi = [], macd = { macdLine: [], signalLine: [], histogram: [] };

            // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø–∞–Ω–µ–ª–∏ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤
            function updateIndicatorsPanel() {
                if (rawData.length === 0) return;
                
                const last = rawData[rawData.length - 1];
                const prev = rawData[rawData.length - 2] || last;
                const panel = document.getElementById('indicatorsPanel');
                const lastRsi = rsi[rsi.length - 1]?.toFixed(2) || 'N/A';
                const lastMacd = macd.macdLine[macd.macdLine.length - 1]?.toFixed(2) || 'N/A';
                const lastSignal = macd.signalLine[macd.signalLine.length - 1]?.toFixed(2) || 'N/A';
                const lastHist = macd.histogram[macd.histogram.length - 1]?.toFixed(2) || 'N/A';
                const sma20Val = sma20[sma20.length - 1]?.toFixed(2) || 'N/A';
                const sma50Val = sma50[sma50.length - 1]?.toFixed(2) || 'N/A';

                panel.innerHTML = `
                    <div class="indicator-card"><h3>–¶–µ–Ω–∞ (Si)</h3><div class="value">${last.close.toFixed(2)}</div><div class="detail">–ò–∑–º: ${(last.close - prev.close).toFixed(2)}</div></div>
                    <div class="indicator-card"><h3>SMA 20 / 50</h3><div class="value">${sma20Val} / ${sma50Val}</div><div class="detail">${sma20Val > sma50Val ? 'üêÇ –ë—ã—á—å–µ' : 'üêª –ú–µ–¥–≤–µ–∂—å–µ'} –ø–µ—Ä–µ—Å–µ—á–µ–Ω–∏–µ</div></div>
                    <div class="indicator-card"><h3>RSI (14)</h3><div class="value">${lastRsi}</div><div class="detail">${lastRsi > 70 ? '–ü–µ—Ä–µ–∫—É–ø–ª–µ–Ω–Ω–æ—Å—Ç—å' : lastRsi < 30 ? '–ü–µ—Ä–µ–ø—Ä–æ–¥–∞–Ω–Ω–æ—Å—Ç—å' : '–ù–µ–π—Ç—Ä–∞–ª—å–Ω–æ'}</div></div>
                    <div class="indicator-card"><h3>MACD</h3><div class="value">${lastMacd}</div><div class="detail">–°–∏–≥–Ω–∞–ª: ${lastSignal} | –ì–∏—Å—Ç: ${lastHist}</div></div>
                `;
            }

            // –§—É–Ω–∫—Ü–∏—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ –≥—Ä–∞—Ñ–∏–∫–∞
            function drawChart() {
                if (typeof LightweightCharts === 'undefined') {
                    document.getElementById('chart').innerHTML = '<div class="error-message">–û—à–∏–±–∫–∞: –ë–∏–±–ª–∏–æ—Ç–µ–∫–∞ –≥—Ä–∞—Ñ–∏–∫–æ–≤ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.</div>';
                    return;
                }
                
                try {
                    const chartContainer = document.getElementById('chart');
                    chartContainer.innerHTML = ''; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –Ω–æ–≤–æ–≥–æ –≥—Ä–∞—Ñ–∏–∫–∞
                    
                    const chart = LightweightCharts.createChart(chartContainer, {
                        width: chartContainer.clientWidth,
                        height: 500,
                        layout: { backgroundColor: '#2a2c39', textColor: '#d1d4dc' },
                        grid: { vertLines: { color: '#404254' }, horzLines: { color: '#404254' } },
                        timeScale: { timeVisible: true, secondsVisible: false },
                    });

                    const candlestickSeries = chart.addCandlestickSeries({
                        upColor: '#4caf50', downColor: '#f44336',
                        borderDownColor: '#f44336', borderUpColor: '#4caf50',
                        wickDownColor: '#f44336', wickUpColor: '#4caf50',
                        title: 'Si-3.26 (—Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)'
                    });
                    candlestickSeries.setData(rawData);

                    // SMA –ª–∏–Ω–∏–∏
                    const sma20Line = chart.addLineSeries({ color: '#FFD700', lineWidth: 2, title: 'SMA20' });
                    const sma50Line = chart.addLineSeries({ color: '#00BFFF', lineWidth: 2, title: 'SMA50' });
                    
                    const sma20Data = [], sma50Data = [];
                    rawData.forEach((d, i) => {
                        if (sma20[i] !== null) sma20Data.push({ time: d.time, value: sma20[i] });
                        if (sma50[i] !== null) sma50Data.push({ time: d.time, value: sma50[i] });
                    });
                    sma20Line.setData(sma20Data);
                    sma50Line.setData(sma50Data);

                    chart.timeScale().fitContent();
                    window.addEventListener('resize', () => chart.applyOptions({ width: chartContainer.clientWidth }));
                } catch (e) {
                    console.error(e);
                    document.getElementById('chart').innerHTML = '<div class="error-message">–û—à–∏–±–∫–∞ —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞: ' + e.message + '</div>';
                }
            }

            // ---------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è: –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ ----------
            async function initApp() {
                const panel = document.getElementById('indicatorsPanel');
                panel.innerHTML = '<div class="indicator-card"><h3>–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å MOEX...</h3><div class="value">‚è≥</div></div>';
                
                rawData = await fetchRealMoexData();
                
                // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã
                sma20 = calculateSMA(rawData, 20);
                sma50 = calculateSMA(rawData, 50);
                rsi = calculateRSI(rawData, 14);
                macd = calculateMACD(rawData, 12, 26, 9);
                
                drawChart();
                updateIndicatorsPanel();
            }

            // –ó–∞–ø—É—Å–∫–∞–µ–º –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é
            initApp();

            // ---------- API –ó–∞–ø—Ä–æ—Å (—á–µ—Ä–µ–∑ –ø—Ä–æ–∫—Å–∏) ----------
            function buildAnalysisPrompt() {
                const recent = rawData.slice(-60);
                const headers = ['Time', 'Open', 'High', 'Low', 'Close', 'SMA20', 'SMA50', 'RSI', 'MACD', 'Signal', 'Histogram'];
                let csvRows = [headers.join(',')];

                recent.forEach((d, idx) => {
                    const globalIdx = rawData.length - 60 + idx;
                    const row = [
                        new Date(d.time * 1000).toISOString().replace('T', ' ').substring(0, 19),
                        d.open.toFixed(2), d.high.toFixed(2), d.low.toFixed(2), d.close.toFixed(2),
                        sma20[globalIdx]?.toFixed(2) || '', sma50[globalIdx]?.toFixed(2) || '',
                        rsi[globalIdx]?.toFixed(2) || '', macd.macdLine[globalIdx]?.toFixed(2) || '',
                        macd.signalLine[globalIdx]?.toFixed(2) || '', macd.histogram[globalIdx]?.toFixed(2) || ''
                    ];
                    csvRows.push(row.join(','));
                });

                return `–ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —Ñ—å—é—á–µ—Ä—Å Si-3.26 (USD/RUB) –ø–æ —á–∞—Å–æ–≤—ã–º –¥–∞–Ω–Ω—ã–º —Å MOEX. –í–æ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 60 —Å–≤–µ—á–µ–π —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º–∏:\n\`\`\`csv\n${csvRows.join('\n')}\n\`\`\`\n–û–ø–∏—à–∏ —Ç–µ–∫—É—â—É—é —Ä—ã–Ω–æ—á–Ω—É—é —Å–∏—Ç—É–∞—Ü–∏—é, —Ç—Ä–µ–Ω–¥, —É—Ä–æ–≤–Ω–∏ –ø–æ–¥–¥–µ—Ä–∂–∫–∏/—Å–æ–ø—Ä–æ—Ç–∏–≤–ª–µ–Ω–∏—è –∏ –≤–æ–∑–º–æ–∂–Ω—ã–µ —Ç–æ—Ä–≥–æ–≤—ã–µ —Å–∏–≥–Ω–∞–ª—ã.`;
            }

            document.getElementById('analyzeBtn').addEventListener('click', async function() {
                const apiKey = document.getElementById('apiKey').value.trim();
                if (!apiKey) {
                    document.getElementById('analysisText').innerText = '‚ùå –í–≤–µ–¥–∏—Ç–µ API –∫–ª—é—á.';
                    return;
                }

                const loader = document.getElementById('loader');
                const analysisDiv = document.getElementById('analysisText');
                loader.style.display = 'inline-block';
                analysisDiv.innerText = '‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ Si-3.26...';

                try {
                    const response = await fetch('/api/proxy', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${apiKey}`
                        },
                        body: JSON.stringify({
                            model: 'deepseek-chat',
                            messages: [
                                { role: 'system', content: '–¢—ã –æ–ø—ã—Ç–Ω—ã–π —Ç—Ä–µ–π–¥–µ—Ä –Ω–∞ —Ä—ã–Ω–∫–µ MOEX. –û—Ç–≤–µ—á–∞–π –Ω–∞ —Ä—É—Å—Å–∫–æ–º, –ø–æ–¥—Ä–æ–±–Ω–æ.' },
                                { role: 'user', content: buildAnalysisPrompt() }
                            ],
                            temperature: 0.3
                        })
                    });

                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error?.message || JSON.stringify(data));
                    
                    analysisDiv.innerText = data.choices[0].message.content;
                } catch (error) {
                    console.error(error);
                    analysisDiv.innerText = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                } finally {
                    loader.style.display = 'none';
                }
            });
        })();
    </script>
</body>
</html>
