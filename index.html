<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Si-3.26 (SiH6) Real Data | DeepSeek AI</title>
    <style>
        * { box-sizing: border-box; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: #1e1f2b; color: #e0e0e0; margin: 0; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        h1 { color: #b0b7ca; font-weight: 400; border-bottom: 1px solid #333; padding-bottom: 10px; }
        
        .status-bar { background: #2a2c39; padding: 10px 20px; border-radius: 8px; margin-bottom: 20px; display: flex; justify-content: space-between; font-size: 14px; color: #aaa; }
        .status-ok { color: #4caf50; }
        .status-error { color: #f44336; }

        .api-section { background: #2a2c39; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: flex; flex-wrap: wrap; align-items: center; gap: 15px; }
        .api-input { flex: 1; min-width: 300px; background: #1e1f2b; border: 1px solid #444; color: white; padding: 12px 15px; border-radius: 6px; }
        button { background: #3a6ea5; border: none; color: white; padding: 12px 30px; border-radius: 6px; font-weight: 600; cursor: pointer; }
        button:hover { background: #4d7db8; }
        button:disabled { background: #555; cursor: not-allowed; }

        .chart-container { background: #2a2c39; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        #chart { width: 100%; height: 500px; }
        
        .indicators-panel { background: #2a2c39; padding: 20px; border-radius: 8px; margin-bottom: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .indicator-card { background: #1e1f2b; padding: 15px; border-radius: 6px; border-left: 4px solid #5f9ea0; }
        .indicator-card h3 { margin: 0 0 10px 0; color: #b0b7ca; font-size: 16px; }
        .indicator-card .value { font-size: 22px; font-weight: 600; color: #d4d7e3; }

        .analysis-result { background: #2a2c39; padding: 20px; border-radius: 8px; }
        pre { background: #1e1f2b; padding: 20px; border-radius: 6px; overflow-x: auto; white-space: pre-wrap; color: #c9d1d9; font-family: 'Consolas', monospace; line-height: 1.6; }
        .loader { border: 3px solid #444; border-top: 3px solid #5f9ea0; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
    <script src="https://unpkg.com/lightweight-charts@4.1.0/dist/lightweight-charts.standalone.production.js"></script>
</head>
<body>
    <div class="container">
        <h1>üìà –†–µ–∞–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ Si-3.26 (SiH6) + DeepSeek AI</h1>

        <div class="status-bar">
            <span>–ò—Å—Ç–æ—á–Ω–∏–∫: <span id="srcStatus" class="status-ok">MOEX API (Direct)</span></span>
            <span>–¢–∏–∫–µ—Ä: <b>SiH6</b></span>
            <span>–°–≤–µ—á–µ–π –∑–∞–≥—Ä—É–∂–µ–Ω–æ: <span id="countStatus">0</span></span>
        </div>

        <div class="api-section">
            <input type="password" id="apiKey" class="api-input" placeholder="DeepSeek API –∫–ª—é—á" value="">
            <button id="analyzeBtn">üîç –ê–Ω–∞–ª–∏–∑ DeepSeek</button>
        </div>

        <div class="chart-container">
            <div id="chart"></div>
        </div>

        <div class="indicators-panel" id="indicatorsPanel"></div>

        <div class="analysis-result">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h2 style="margin:0; color:#b0b7ca;">–ü—Ä–æ–≥–Ω–æ–∑</h2>
                <div id="loader" class="loader" style="display:none;"></div>
            </div>
            <pre id="analysisText">–û–∂–∏–¥–∞–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...</pre>
        </div>
    </div>

    <script>
        (function() {
            // –¢–∏–∫–µ—Ä Si-3.26 -> SiH6
            const TICKER = 'SiH6'; 
            
            let chart = null;
            let candleSeries = null;
            let rawData = []; // –ó–¥–µ—Å—å –±—É–¥—É—Ç —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ

            // 1. –§—É–Ω–∫—Ü–∏—è –ø–æ–ª—É—á–µ–Ω–∏—è –†–ï–ê–õ–¨–ù–´–• –¥–∞–Ω–Ω—ã—Ö —Å MOEX
            async function loadRealData() {
                const chartDiv = document.getElementById('chart');
                chartDiv.innerHTML = '<div style="color:#888; text-align:center; padding-top:200px;">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Å MOEX ISS...</div>';

                try {
                    // API MOEX –¥–ª—è —Ñ—å—é—á–µ—Ä—Å–æ–≤ (FORTS), —á–∞—Å–æ–≤—ã–µ —Å–≤–µ—á–∏ (interval=60)
                    // verified=true —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ –ø–æ–ª—É—á–∏—Ç—å —Ç–æ—Ä–≥–æ–≤—ã–π —Ç–∏–∫–µ—Ä, –µ—Å–ª–∏ –µ—Å—Ç—å
                    const url = `https://iss.moex.com/iss/engines/futures/markets/forts/securities/${TICKER}/candles.json?interval=60&reverse=true`;
                    
                    const response = await fetch(url);
                    const json = await response.json();

                    const columns = json.candles.columns;
                    const data = json.candles.data;

                    if (!data || data.length === 0) {
                        chartDiv.innerHTML = `<div style="color:#f44336; text-align:center; padding-top:200px;">
                            <h3>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –ø–æ —Ç–∏–∫–µ—Ä—É ${TICKER}</h3>
                            <p>–í–æ–∑–º–æ–∂–Ω–æ, —Ç–æ—Ä–≥–∏ –µ—â–µ –Ω–µ –Ω–∞—á–∞–ª–∏—Å—å –∏–ª–∏ —Ç–∏–∫–µ—Ä –Ω–µ –∞–∫—Ç–∏–≤–µ–Ω.</p>
                        </div>`;
                        return false;
                    }

                    // –ü–∞—Ä—Å–∏–Ω–≥
                    const idx = {
                        open: columns.indexOf('open'),
                        close: columns.indexOf('close'),
                        high: columns.indexOf('high'),
                        low: columns.indexOf('low'),
                        volume: columns.indexOf('volume'),
                        begin: columns.indexOf('begin')
                    };

                    // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –≤ —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–∞
                    // MOEX –æ—Ç–¥–∞–µ—Ç –≤—Ä–µ–º—è –≤ MSK (UTC+3). –ì—Ä–∞—Ñ–∏–∫—É –Ω—É–∂–Ω–æ UTC.
                    rawData = data.map(row => {
                        // –°—Ç—Ä–æ–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ "2024-01-01 10:00:00" -> —Ç–∞–π–º—Å—Ç–µ–º–ø–∞ UTC
                        const dateStr = row[idx.begin]; 
                        // –î–æ–±–∞–≤–ª—è–µ–º +03:00 —á—Ç–æ–±—ã —É–∫–∞–∑–∞—Ç—å —á—Ç–æ —ç—Ç–æ –ú–°–ö, –∑–∞—Ç–µ–º –ø–∞—Ä—Å–∏–º
                        const mskDate = new Date(dateStr.replace(' ', 'T') + '+03:00');
                        
                        return {
                            time: Math.floor(mskDate.getTime() / 1000),
                            open: parseFloat(row[idx.open]),
                            high: parseFloat(row[idx.high]),
                            low: parseFloat(row[idx.low]),
                            close: parseFloat(row[idx.close]),
                            volume: parseFloat(row[idx.volume])
                        };
                    }).reverse(); // MOEX –æ—Ç–¥–∞–µ—Ç –Ω–æ–≤—ã–µ –ø–µ—Ä–≤—ã–º–∏, —Ä–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º

                    document.getElementById('countStatus').innerText = rawData.length;
                    return true;

                } catch (e) {
                    console.error(e);
                    chartDiv.innerHTML = `<div style="color:#f44336; text-align:center;">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ MOEX.<br>${e.message}</div>`;
                    return false;
                }
            }

            // 2. –†–∞—Å—á–µ—Ç –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–≤ (–Ω–∞ –æ—Å–Ω–æ–≤–µ rawData)
            function calcIndicators() {
                if (rawData.length < 50) return { sma20: [], sma50: [], rsi: [], macd: {} };

                // SMA
                const sma20 = [], sma50 = [];
                for (let i = 0; i < rawData.length; i++) {
                    if (i < 19) sma20.push(null);
                    else {
                        let sum = 0; for(let j=i-19; j<=i; j++) sum+=rawData[j].close;
                        sma20.push(sum/20);
                    }
                    if (i < 49) sma50.push(null);
                    else {
                        let sum = 0; for(let j=i-49; j<=i; j++) sum+=rawData[j].close;
                        sma50.push(sum/50);
                    }
                }

                // RSI (14)
                const rsi = [];
                for (let i = 0; i < rawData.length; i++) {
                    if (i < 14) { rsi.push(null); continue; }
                    let gain=0, loss=0;
                    for(let j=i-13; j<=i; j++) {
                        let diff = rawData[j].close - rawData[j-1].close;
                        if (diff > 0) gain+=diff; else loss-=diff;
                    }
                    let rs = gain/14 / (loss/14 || 0.0001);
                    rsi.push(100 - 100/(1+rs));
                }

                // MACD
                // (–£–ø—Ä–æ—â–µ–Ω–Ω—ã–π EMA —Ä–∞—Å—á–µ—Ç –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞)
                const macd = { line: [], signal: [] };
                const ema12 = [], ema26 = [];
                let k12 = 2/13, k26 = 2/27;
                
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è EMA
                let sum12=0, sum26=0;
                for(let i=0; i<26; i++) {
                    if(i<12) sum12+=rawData[i].close;
                    sum26+=rawData[i].close;
                }
                ema12[11] = sum12/12;
                ema26[25] = sum26/26;

                for(let i=12; i<rawData.length; i++) {
                    ema12[i] = rawData[i].close * k12 + ema12[i-1] * (1-k12);
                    if(i>=26) ema26[i] = rawData[i].close * k26 + ema26[i-1] * (1-k26);
                    else ema26[i] = null;
                    if(i>=25) macd.line.push(ema12[i] - ema26[i]);
                    else macd.line.push(null);
                }

                return { sma20, sma50, rsi, macd };
            }

            // 3. –û—Ç—Ä–∏—Å–æ–≤–∫–∞
            function drawChart(inds) {
                const container = document.getElementById('chart');
                container.innerHTML = '';
                
                chart = LightweightCharts.createChart(container, {
                    width: container.clientWidth,
                    height: 500,
                    layout: { backgroundColor: '#2a2c39', textColor: '#d1d4dc' },
                    grid: { vertLines: { color: '#404254' }, horzLines: { color: '#404254' } },
                    timeScale: { timeVisible: true }
                });

                candleSeries = chart.addCandlestickSeries({
                    upColor: '#4caf50', downColor: '#f44336',
                    borderUpColor: '#4caf50', borderDownColor: '#f44336',
                    wickUpColor: '#4caf50', wickDownColor: '#f44336'
                });
                candleSeries.setData(rawData);

                // SMA Lines
                const line20 = chart.addLineSeries({ color: '#FFD700', lineWidth: 2, title: 'SMA 20' });
                const line50 = chart.addLineSeries({ color: '#00BFFF', lineWidth: 2, title: 'SMA 50' });
                
                const d20 = [], d50 = [];
                rawData.forEach((d, i) => {
                    if(inds.sma20[i]) d20.push({time: d.time, value: inds.sma20[i]});
                    if(inds.sma50[i]) d50.push({time: d.time, value: inds.sma50[i]});
                });
                line20.setData(d20);
                line50.setData(d50);

                chart.timeScale().fitContent();
                
                // Update Panel
                const last = rawData[rawData.length-1];
                const prev = rawData[rawData.length-2];
                const lRsi = inds.rsi[inds.rsi.length-1];
                
                document.getElementById('indicatorsPanel').innerHTML = `
                    <div class="indicator-card"><h3>Close</h3><div class="value">${last.close.toFixed(2)}</div></div>
                    <div class="indicator-card"><h3>SMA 20</h3><div class="value">${inds.sma20[inds.sma20.length-1]?.toFixed(2) || '-'}</div></div>
                    <div class="indicator-card"><h3>RSI (14)</h3><div class="value">${lRsi?.toFixed(2) || '-'}</div></div>
                    <div class="indicator-card"><h3>Change</h3><div class="value" style="color:${last.close > prev.close ? '#4caf50' : '#f44336'}">${(last.close - prev.close).toFixed(2)}</div></div>
                `;
            }

            // 4. DeepSeek
            document.getElementById('analyzeBtn').addEventListener('click', async () => {
                const key = document.getElementById('apiKey').value;
                if(!key) return alert("–í–≤–µ–¥–∏—Ç–µ –∫–ª—é—á");

                const btn = document.getElementById('analyzeBtn');
                const txt = document.getElementById('analysisText');
                const loader = document.getElementById('loader');
                
                btn.disabled = true; loader.style.display = 'inline-block';
                txt.innerText = "–ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ä–µ–∞–ª—å–Ω—ã–π —Ä—ã–Ω–æ–∫...";

                // –§–æ—Ä–º–∏—Ä—É–µ–º CSV –∏–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 —Å–≤–µ—á–µ–π)
                const recent = rawData.slice(-30);
                let csv = "Time,Open,High,Low,Close,Volume\n";
                recent.forEach(d => {
                    csv += `${new Date(d.time*1000).toISOString()},${d.open},${d.high},${d.low},${d.close},${d.volume}\n`;
                });

                try {
                    const res = await fetch('/api/proxy', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}` },
                        body: JSON.stringify({
                            model: 'deepseek-chat',
                            messages: [{
                                role: 'user', 
                                content: `–Ø —Ç–æ—Ä–≥—É—é —Ñ—å—é—á–µ—Ä—Å SiH6 (Si-3.26). –í–æ—Ç —Ä–µ–∞–ª—å–Ω—ã–µ —á–∞—Å–æ–≤—ã–µ —Å–≤–µ—á–∏ —Å MOEX:\n${csv}\n–î–∞–π –∫—Ä–∞—Ç–∫–∏–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑.`
                            }]
                        })
                    });
                    const data = await res.json();
                    if(data.error) throw new Error(data.error.message);
                    txt.innerText = data.choices[0].message.content;
                } catch(e) {
                    txt.innerText = "–û—à–∏–±–∫–∞: " + e.message;
                } finally {
                    btn.disabled = false; loader.style.display = 'none';
                }
            });

            // INIT
            (async () => {
                const success = await loadRealData();
                if (success) {
                    const indicators = calcIndicators();
                    drawChart(indicators);
                }
            })();

        })();
    </script>
</body>
</html>
